rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ======= ğŸ”§ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© =======
    function isSignedIn() {
      return request.auth != null;
    }

    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isUserActive() {
      return isSignedIn() && 
        userExists() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('isActive', false) == true;
    }

    function isAdmin() {
      return isSignedIn() && 
        userExists() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('isAdmin', false) == true;
    }

    function userOwnsDocument() {
      return isSignedIn() && 
        resource != null && 
        resource.data.userId == request.auth.uid;
    }

    function userHasCompany(companyId) {
      return isSignedIn() && 
        userExists() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid))
          .data.get('companyIds', []).hasAny([companyId]);
    }

    function userHasSupplier(supplierId) {
      return isSignedIn() && 
        userExists() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid))
          .data.get('supplierIds', []).hasAny([supplierId]);
    }
    
    function userHasFactory(factoryId) {
      return isSignedIn() && 
        userExists() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid))
          .data.get('factoryIds', []).hasAny([factoryId]);
    }
    
    function userHasAnyCompanyInFactory(factoryId) {
      return isSignedIn() && 
        userExists() && 
        get(/databases/$(database)/documents/factories/$(factoryId))
          .data.get('companyIds', []).hasAny(
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('companyIds', [])
          );
    }

    // ======= ğŸ” Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ (LICENSES) =======
    match /licenses/{licenseId} {
      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow read: if isSignedIn() && (userOwnsDocument() || isAdmin());
      
      // âœ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù„Ø­Ù‚Ù„ devices ÙÙ‚Ø·) Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow update: if isSignedIn() && 
        ((userOwnsDocument() && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['devices', 'lastUpdated'])) || 
         isAdmin());
      
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ù„Ø­Ø°Ù: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow create, delete: if isAdmin();
      
      // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª
      allow list: if isSignedIn() && (isAdmin() || userOwnsDocument());
    }

    // ======= ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (USERS) =======
    match /users/{userId} {
      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());

      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯Ù‡ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·
      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.userId == userId
        && !exists(/databases/$(database)/documents/users/$(userId));

      // âœ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow update: if isSignedIn()
        && (request.auth.uid == userId || isAdmin())
        && (
          // âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ: ÙŠØ³Ù…Ø­ Ù„Ù‡ Ø¨ØªØ¹Ø¯ÙŠÙ„ deviceIds Ùˆ lastUpdated ÙÙ‚Ø·
          (request.auth.uid == userId
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['deviceIds', 'lastUpdated']))
          ||
          // âœ… Ø§Ù„Ø£Ø¯Ù…Ù†: ÙŠÙ…ÙƒÙ†Ù‡ ØªØ¹Ø¯ÙŠÙ„ Ø£ÙŠ Ø­Ù‚Ù„
          (isAdmin())
        );

      // âœ… Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow delete: if isAdmin();
    }

    // ======= ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (DEVICE_REQUESTS) =======
    match /device_requests/{requestId} {
      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow read: if isSignedIn() && 
        (request.auth.uid == resource.data.userId || isAdmin());
      
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù„Ù†ÙØ³Ù‡ ÙÙ‚Ø·
      allow create: if isSignedIn() && 
        request.auth.uid == request.resource.data.userId;
      
      // âœ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow update: if isSignedIn() && isAdmin();
      
      // âœ… Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow delete: if isSignedIn() && 
        (request.auth.uid == resource.data.userId || isAdmin());
      
      // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow list: if isSignedIn() && isAdmin();
    }

    // ======= ğŸ“ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ±Ø®ÙŠØµ (LICENSE_REQUESTS) =======
    match /license_requests/{requestId} {
      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow read: if isSignedIn() && 
        (isAdmin() || resource.data.userId == request.auth.uid);
      
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù„Ù†ÙØ³Ù‡ ÙÙ‚Ø·
      allow create: if isSignedIn() && 
        request.auth.uid == request.resource.data.userId;
      
      // âœ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„Ø­Ø°Ù: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow update, delete: if isSignedIn() && isAdmin();
      
      // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow list: if isSignedIn() && isAdmin();
    }

    // ======= ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (NOTIFICATIONS) =======
    match /notifications/{notificationId} {
      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ ÙÙ‚Ø·
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ø£Ø¯Ù…Ù† Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù†ÙØ³Ù‡
      allow create: if isSignedIn() && 
        (isAdmin() || request.resource.data.userId == request.auth.uid);
      
      // âœ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„Ø­Ø°Ù: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow update, delete: if isSignedIn() && isAdmin();
    }

    // ======= ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ§Øª (COMPANIES) =======
    match /companies/{companyId} {
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·
      allow create: if isSignedIn() && isUserActive();
      
      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„Ø­Ø°Ù: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø´Ø±ÙƒØ©
      allow read, update, delete: if isSignedIn() && 
        isUserActive() && 
        userHasCompany(companyId);
        
      // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·
      allow list: if isSignedIn() && isUserActive();
    }

    // ======= ğŸ­ Ø§Ù„Ù…ØµØ§Ù†Ø¹ (FACTORIES) =======
    match /factories/{factoryId} {
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· ÙˆØ§Ù„Ù…Ø§Ù„Ùƒ
      allow create: if isSignedIn() && 
        isUserActive() && 
        request.resource.data.userId == request.auth.uid;

      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù„Ùƒ Ø´Ø±ÙƒØ§Øª ÙÙŠ Ø§Ù„Ù…ØµÙ†Ø¹
      allow read: if isSignedIn() && 
        (
          resource.data.userId == request.auth.uid ||
          resource.data.companyIds.hasAny(
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyIds
          )
        );

      // âœ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„Ø­Ø°Ù: Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·
      allow update, delete: if isSignedIn() && 
        isUserActive() && 
        resource.data.userId == request.auth.uid;
        
      // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·
      allow list: if isSignedIn() && isUserActive();
    }

    // ======= ğŸ›’ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (VENDORS) =======
    match /vendors/{supplierId} {
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·
      allow create: if isSignedIn() && isUserActive();

      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…ÙˆØ±Ø¯
      allow read: if isSignedIn() && 
        isUserActive() && 
        (resource.data.userId == request.auth.uid || userHasSupplier(supplierId));

      // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· ÙÙ‚Ø·
      allow list: if isSignedIn() && isUserActive();

      // âœ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„Ø­Ø°Ù: Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…ÙˆØ±Ø¯
      allow update, delete: if isSignedIn() && 
        isUserActive() && 
        (resource.data.userId == request.auth.uid || userHasSupplier(supplierId));
    }

    // ======= ğŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù (ITEMS) =======
    match /items/{itemId} {
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· ÙˆØ§Ù„Ù…Ø§Ù„Ùƒ
      allow create: if isSignedIn() && 
        isUserActive() && 
        request.resource.data.userId == request.auth.uid;
      
      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·
      allow read: if isSignedIn() && isUserActive();
      
      // âœ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„Ø­Ø°Ù: Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·
      allow update, delete: if isSignedIn() && 
        isUserActive() && 
        resource.data.userId == request.auth.uid;
        
      // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·
      allow list: if isSignedIn() && isUserActive();
    }

    // ======= ğŸ›ï¸ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (PURCHASE_ORDERS) =======
    match /purchase_orders/{orderId} {
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø´Ø±ÙƒØ©
      allow create, update: if isSignedIn() && 
        isUserActive() && 
        userHasCompany(request.resource.data.companyId);

      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·
      allow read, list: if isSignedIn() && isUserActive();

      // âœ… Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø´Ø±ÙƒØ© ÙˆÙ„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…ØŒ Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow delete: if isSignedIn() && 
        isUserActive() && 
        (
          (userHasCompany(resource.data.companyId) && (resource.data.isDelivered != true)) ||
          isAdmin()
        );
    }

    // ======= ğŸ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ù…Ø© (FINISHED_PRODUCTS) =======
    match /finished_products/{prodId} {
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø´Ø±ÙƒØ©
      allow create: if isSignedIn() && 
        isUserActive() && 
        userHasCompany(request.resource.data.companyId);
      
      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·
      allow read: if isSignedIn() && isUserActive();
      
      // âœ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„Ø­Ø°Ù: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø´Ø±ÙƒØ©
      allow update, delete: if isSignedIn() && 
        isUserActive() && 
        userHasCompany(resource.data.companyId);
        
      // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·
      allow list: if isSignedIn() && isUserActive();
    }

    // ======= âš™ï¸ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØµÙ†ÙŠØ¹ (MANUFACTURING_ORDERS) =======
    match /manufacturing_orders/{orderId} {
      // âœ… Ø§Ù„ÙƒØªØ§Ø¨Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø´Ø±ÙƒØ©
      allow write: if isSignedIn() && 
        resource.data.companyId in request.auth.token.companyIds;
      
      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·
      allow read: if isSignedIn() && isUserActive();
      
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚
      allow create: if isSignedIn();
      
      // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·
      allow list: if isSignedIn() && isUserActive();
    }

    // ======= ğŸ“Š Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙÙŠ Ø§Ù„Ù…ØµØ§Ù†Ø¹ (FACTORY INVENTORY) =======
    match /factories/{factoryId}/inventory/{productId} {
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù„Ùƒ Ø´Ø±ÙƒØ§Øª ÙÙŠ Ø§Ù„Ù…ØµÙ†Ø¹
      allow create, read, update: if isSignedIn() && 
        isUserActive() && 
        userHasAnyCompanyInFactory(factoryId);
      
      // âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ù…ØµÙ†Ø¹
      allow read: if isSignedIn() && 
        isUserActive() && 
        userHasFactory(factoryId);
    }

    // ======= ğŸ“ˆ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ© (STOCK MOVEMENTS) =======
    match /companies/{companyId}/stock_movements/{movementId} {
      // âœ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø´Ø±ÙƒØ©
      allow create, read: if isSignedIn() && 
        isUserActive() && 
        userHasCompany(companyId);
    }

    // ======= ğŸ§© Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (PRODUCT COMPOSITION) =======
    match /finished_products/{productId}/composition/{document} {
      // âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø´Ø±ÙƒØ©
      allow create, read, update, delete: if isSignedIn() && 
        isUserActive() && 
        userHasCompany(
          get(/databases/$(database)/documents/finished_products/$(productId))
            .data.companyId
        );
    }
  }
}




// 1. run : #  firebase emulators:exec "npm run test:rules"
// 2. run : #  firebase deploy --only firestore:rules